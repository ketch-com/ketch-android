name: Integration Tests

on:
  push:
    branches: [ main, develop, cursor/add-github-action-for-integration-tests-97e2 ]
  pull_request:
    branches: [ main, develop ]

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: Setup Android SDK
      uses: android-actions/setup-android@v3.2.2
      
    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      
    - name: Grant execute permission for integration test script
      run: chmod +x run-integration-tests.sh
      
    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-
          
    - name: Validate build environment
      run: |
        echo "ğŸ” Validating build environment..."
        echo "Java version:"
        java -version
        echo "Android SDK components:"
        sdkmanager --list | head -20
        
    - name: Build project
      run: |
        echo "ğŸ—ï¸ Building main SDK..."
        ./gradlew :ketchsdk:build --stacktrace
        
        echo "ğŸ—ï¸ Building integration tests..."
        ./gradlew :integration-tests:build --stacktrace
        
    - name: Run unit tests
      run: |
        echo "ğŸ§ª Running unit tests..."
        ./gradlew :ketchsdk:test --stacktrace
        ./gradlew :integration-tests:testDebugUnitTest --stacktrace
        
    - name: Build APKs
      run: |
        echo "ğŸ“¦ Building debug APK..."
        ./gradlew :integration-tests:assembleDebug --stacktrace
        
        echo "ğŸ“¦ Building test APK..."  
        ./gradlew :integration-tests:assembleDebugAndroidTest --stacktrace
        
        echo "âœ… APKs built successfully!"
        ls -la integration-tests/build/outputs/apk/debug/
        ls -la integration-tests/build/outputs/apk/androidTest/debug/
        
    - name: Validate integration test script
      run: |
        echo "ğŸ” Validating integration test script..."
        head -20 run-integration-tests.sh
        echo "âœ… Integration test script is present and executable"
        
    - name: Summary
      run: |
        echo ""
        echo "ğŸ‰ Integration test environment validation completed successfully!"
        echo ""
        echo "âœ… Java 17 environment set up"
        echo "âœ… Android SDK configured" 
        echo "âœ… Gradle build successful"
        echo "âœ… Unit tests passing"
        echo "âœ… Integration test APKs built"
        echo "âœ… Integration test script validated"
        echo ""
        echo "ğŸ“ To run actual integration tests:"
        echo "   1. Set up an Android emulator"
        echo "   2. Run: ./run-integration-tests.sh"
        echo "   3. Or run: ./gradlew :integration-tests:connectedAndroidTest"
        echo ""
        echo "ğŸ”§ This workflow validates that the integration test environment"
        echo "   is properly configured and ready for testing."
          
